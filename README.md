# Gapless Audio MSE
Gapless Audio MSE uses MSE to concatenate two encoded fragmented MP4 (AAC) files 
into a gapless audio stream. If player and MSE work correctly, the transition in
the middle should be seamless and users shouldn't hear a pop.

To try it out, please visit [Gapless Audio MSE Demo](https://nzhang227.github.io/gapless_audio_mse/demo.html).

# Details about the test files
The gapless test files are under resource folder.

## About tone_(1|2).mp4
The flac files were generated by splitting a single file into 2 flacs.
Each flac is 110250 samples.

The flac files were re-encoded to AAC with an encoder which has an encoder delay
of 1600 samples, and muxed into fragmented mp4 files.
(These examples have single fragment, but others will not).

The FMP4 files were produced by
 * Setting mvhd.timescale and mdhd.timescale to the sample rate.
 * Adding single edit to edit list
 * Setting edit media time to 1600, to account for encoder delay.
 * Setting edit segment duration to 110250, to account for trailing samples due 
 to AAC packet sample count.
 * All presentation durations are also 110250, as they should be.
   (sidx durations, mvhd.duration, tkhd.duration, mdhd.duration)

The encoded AAC fragmented MP4 files have the following properties:
 * Encoder delay of 1600 samples.
 * Edit list with media time of 1600 and segment duration of 110250
 * In order to get gapless playback, 1600 leading samples and 790 trailing 
 samples should be trimmed
 * After trimming leading and trailing samples (due to edit list), there should 
 be 110250 samples.

Let's do some math:
* segment_duration = 110250 (2.5s)
* media_time =  1600
* total_frames = 110
* samples_per_frame = 1024
* total_samples_before_trim = total_frames * samples_per_frame = 112640
* total_samples_after_trim = segment_duration = 110250
* leading_samples_to_trim = 1600
* trailing_samples_to_trim = total_samples_before_trim - total_samples_after_trim - leading_samples_to_trim = 790

## About tone_(1|2)_no_elst.mp4
It seems like most media stacks don't handle ELST correctly. In order to workaround this, we have another test case to remove all the special features that browser can mess up on trimming. 

In order to do that, I manually changed the test files using a hex editor:
* Mark EDTS as SKIP box. Simply search in the binary for EDTS and change it to SKIP
* Set last packet duraion in TRUN back to 1024